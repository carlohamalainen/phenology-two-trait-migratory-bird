function [resV,Jac] = check_conv(p,yzV,x_cV)

% -- [resV,Jac] = check_conv(p,yzV,x_cV)
%
% The purpose of this function is to check the convergence
% stability of each evolutionarily singular strategy defined
% by the inputs. The check is done by finding the largest
% eigenvalue of the Jacobian matrix and returning it to the
% user, who can verify that they are zero.
% 
% This code uses a semi-analytic approach in
% that the expressions for each of the derivatives and
% second derivatives were found using Sage. This code also
% has a counterpart numcheck_conv.m which finds the
% eigenvalues numerically. Agreement between the two methods
% was used a check of the correctness of the solutions.
%
%
% INPUTS
%
% p: A dictionary of parameter values. Use the file params.m
% for an example of how to specify one of these.
%
% yzV: A matrix of [y*,z*] values corresponding to x_cV for 
% easy plotting.
%
% x_cV: A vector of x_c values at which [y*,z*] were
% calculated.
%
%
% OUTPUTS
%
% resV: A vector of largest eigenvalues of the Jacobian
% matrix corresponding to the evolutionarily singular
% strategies specified by the inputs.
%
% Jac: The Jacobian matrix of the last evolutionarily
% singular strategy specified. It is useful if you want to
% take a closer look at just one singular strategy.
%
%
% see also: numcheck_conv, check_ess
%

% Pull out parameters, just makes code easier to read
K = p.K; b_e = p.b_e; a = p.a; sigma = p.sigma; Q_0 = p.Q_0; b_q = p.b_q; u_q = p.u_q; L_m = p.L_m; b_s = p.b_s; M = p.M; z_f = p.z_f; z_n = p.z_n;

resV = []; % Storage vector for output

% This loop steps through each of our x_c values
for ind = 1:length(x_cV);

    yz = yzV(ind,:);
    x_c = x_cV(ind);
    y = yz(1); z = yz(2);

    % Calculate each component's value
    Ps = calc_Ps(p,y,z);
    Pf = calc_Pf(p,y,z,x_c);
    Ph = calc_Ph(p,y,z);
    n = calcn(p,yz,x_c);
    Pe = K/n;

    % Calculate first derivatives with respect to the mutant. 
    % These expressions were found using Sage. 

    dPsdy = -(b_s*e^(-(y + z_n + z_f + z)*b_s) - b_s*e^(-b_s*y))*L_m*e^((e^(-(y + z_n + z_f + z)*b_s) - e^(-b_s*y))*L_m/b_s)/b_s;
    dPsdz = -L_m*e^(-(y + z_n + z_f + z)*b_s + (e^(-(y + z_n + z_f + z)*b_s) - e^(-b_s*y))*L_m/b_s);

    dPfdy = (x_c - y - z - z_n)*a*e^(-1/2*(x_c - y - z - z_n)^2/sigma^2)/sigma^2;
    dPfdz = dPfdy;

    dPhdy = -(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))*Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)) + (e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))*Q_0^2*e^(2*z + 2*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 2*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^2*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^2);

    dPhdz = -(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)*Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)) + (e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)*Q_0^2*e^(2*z + 2*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 2*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^2*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^2);

    % For all of the above, e.g. dPsdy' = dPsdy. Except for Pe because of density dependence

    dPsdY = dPsdy;
    dPsdZ = dPsdz;
    dPfdY = dPfdy;
    dPfdZ = dPfdz;
    dPhdY = dPhdy;
    dPhdZ = dPhdz;

    % For Pe, 

    Y = y;

    dPedy = -b_e*e^((Y + log(-K/((K/n - 1)*n))/b_e)*b_e + b_e*y)/(e^((Y + log(-K/((K/n - 1)*n))/b_e)*b_e) + e^(b_e*y))^2;
    dPedY = (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*((b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m/b_s + e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1) - (x_c - y - z - z_n)/sigma^2)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) + (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m*e^(-z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a*b_s) - (1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + 1/2*(x_c - y - z - z_n)^2/sigma^2)/a;
    
    dPedz = 0;
    dPedZ = (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*(L_m*e^(-(y + z + z_f + z_n)*b_s) + e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - (x_c - y - z - z_n)/sigma^2 - 1)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - (e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + 1/2*(x_c - y - z - z_n)^2/sigma^2)/a + (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*L_m*e^(-(y + z + z_f + z_n)*b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a);


    % The second derivative involves taking dPedy, putting the n term in terms of y and z, and then taking the second derivative. This part is different to ESS calculation, because it involves the population steady state, and is differentiated wrt the resident trait on the second differentiation

    dPedydy = -((((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*((b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m/b_s + e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1) - (x_c - y - z - z_n)/sigma^2)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a) + (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m*e^(-z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a*b_s) - (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*((b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m/b_s + e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1) - (x_c - y - z - z_n)/sigma^2)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) + (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m*e^(-z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a*b_s) - (1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + 1/2*(x_c - y - z - z_n)^2/sigma^2)/a)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)^2*Q_0*a) - (1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + 1/2*(x_c - y - z - z_n)^2/sigma^2)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*a))*Q_0*a*e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + z - 1/2*(x_c - y - z - z_n)^2/sigma^2 + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*b_e) + 1)*b_e + b_e)*b_e*e^((y + log(-(Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a))/b_e)*b_e + b_e*y)/(e^((y + log(-(Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a))/b_e)*b_e) + e^(b_e*y))^2 + 2*((((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*((b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m/b_s + e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1) - (x_c - y - z - z_n)/sigma^2)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a) + (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m*e^(-z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a*b_s) - (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*((b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m/b_s + e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1) - (x_c - y - z - z_n)/sigma^2)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) + (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m*e^(-z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a*b_s) - (1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + 1/2*(x_c - y - z - z_n)^2/sigma^2)/a)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)^2*Q_0*a) - (1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + 1/2*(x_c - y - z - z_n)^2/sigma^2)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*a))*Q_0*a*e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + z - 1/2*(x_c - y - z - z_n)^2/sigma^2 + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*b_e) + 1)*b_e*e^((y + log(-(Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a))/b_e)*b_e) + b_e*e^(b_e*y))*b_e*e^((y + log(-(Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a))/b_e)*b_e + b_e*y)/(e^((y + log(-(Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a))/b_e)*b_e) + e^(b_e*y))^3;
    dPedydz = -((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*(L_m*e^(-(y + z + z_f + z_n)*b_s) + e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - (x_c - y - z - z_n)/sigma^2 - 1)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a) - (e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + 1/2*(x_c - y - z - z_n)^2/sigma^2)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*a) + (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*L_m*e^(-(y + z + z_f + z_n)*b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a) - (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*(L_m*e^(-(y + z + z_f + z_n)*b_s) + e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - (x_c - y - z - z_n)/sigma^2 - 1)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - (e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + 1/2*(x_c - y - z - z_n)^2/sigma^2)/a + (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*L_m*e^(-(y + z + z_f + z_n)*b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)^2*Q_0*a))*Q_0*a*b_e*e^((y + log(-(Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a))/b_e)*b_e + b_e*y + (e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + z - 1/2*(x_c - y - z - z_n)^2/sigma^2 + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(e^((y + log(-(Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a))/b_e)*b_e) + e^(b_e*y))^2*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))) + 2*((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*(L_m*e^(-(y + z + z_f + z_n)*b_s) + e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - (x_c - y - z - z_n)/sigma^2 - 1)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a) - (e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + 1/2*(x_c - y - z - z_n)^2/sigma^2)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*a) + (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*L_m*e^(-(y + z + z_f + z_n)*b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a) - (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*(L_m*e^(-(y + z + z_f + z_n)*b_s) + e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - (x_c - y - z - z_n)/sigma^2 - 1)*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - (e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + 1/2*(x_c - y - z - z_n)^2/sigma^2)/a + (Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*L_m*e^(-(y + z + z_f + z_n)*b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)^2*Q_0*a))*Q_0*a*b_e*e^(2*(y + log(-(Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a))/b_e)*b_e + b_e*y + (e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s + z - 1/2*(x_c - y - z - z_n)^2/sigma^2 + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(e^((y + log(-(Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s))*e^(-(e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s - z + 1/2*(x_c - y - z - z_n)^2/sigma^2 - log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q + log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0*a) - 1)*Q_0*a))/b_e)*b_e) + e^(b_e*y))^3*(1/M - e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s)));
    dPedzdy = 0; 
    dPedzdz = 0; 

    % The second derivatives for the rest are pretty straightforward, if a little lengthy
    % I'm going to call them dPsdydy etc, but if I was to be really consistent, they'd be called dPsdydY.


    dPsdydy = (b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))^2*L_m^2*e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s)/b_s^2 + (b_s^2*e^(-(y + z + z_f + z_n)*b_s) - b_s^2*e^(-b_s*y))*L_m*e^((e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s)/b_s;
    dPsdydz = (b_s*e^(-(y + z + z_f + z_n)*b_s) - b_s*e^(-b_s*y))*L_m^2*e^(-(y + z + z_f + z_n)*b_s + (e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s)/b_s + L_m*b_s*e^(-(y + z + z_f + z_n)*b_s + (e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s);
    dPsdzdz = (L_m*e^(-(y + z + z_f + z_n)*b_s) + b_s)*L_m*e^(-(y + z + z_f + z_n)*b_s + (e^(-(y + z + z_f + z_n)*b_s) - e^(-b_s*y))*L_m/b_s);
    dPsdzdy = dPsdydz;


    dPfdydy = (x_c - y - z - z_n)^2*a*e^(-1/2*(x_c - y - z - z_n)^2/sigma^2)/sigma^4 - a*e^(-1/2*(x_c - y - z - z_n)^2/sigma^2)/sigma^2;
    dPfdydz = dPfdydy;
    dPfdzdz = dPfdydy;
    dPfdzdy = dPfdydy;


    dPhdydy = (e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))^2*Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)) + (b_q*e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - b_q*e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1) - b_q*e^(-2*(y + z)*b_q + 2*b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1)^2 + b_q*e^(2*b_q*u_q - 2*b_q*y)/(e^(b_q*u_q - b_q*y) + 1)^2)*Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)) - 3*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))^2*Q_0^2*e^(2*z + 2*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 2*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^2*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^2) - (b_q*e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - b_q*e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1) - b_q*e^(-2*(y + z)*b_q + 2*b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1)^2 + b_q*e^(2*b_q*u_q - 2*b_q*y)/(e^(b_q*u_q - b_q*y) + 1)^2)*Q_0^2*e^(2*z + 2*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 2*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^2*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^2) + 2*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))^2*Q_0^3*e^(3*z + 3*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 3*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^3*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^3);

    dPhdydz = (e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))*Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)) - 3*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))*Q_0^2*e^(2*z + 2*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 2*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^2*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^2) + (b_q*e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - b_q*e^(-2*(y + z)*b_q + 2*b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1)^2)*Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)) + 2*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - e^(b_q*u_q - b_q*y)/(e^(b_q*u_q - b_q*y) + 1))*Q_0^3*e^(3*z + 3*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 3*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^3*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^3) - (b_q*e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - b_q*e^(-2*(y + z)*b_q + 2*b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1)^2)*Q_0^2*e^(2*z + 2*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 2*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^2*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^2);

    dPhdzdz = (e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)^2*Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)) - 3*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)^2*Q_0^2*e^(2*z + 2*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 2*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^2*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^2) + (b_q*e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - b_q*e^(-2*(y + z)*b_q + 2*b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1)^2)*Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)) + 2*(e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - 1)^2*Q_0^3*e^(3*z + 3*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 3*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^3*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^3) - (b_q*e^(-(y + z)*b_q + b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1) - b_q*e^(-2*(y + z)*b_q + 2*b_q*u_q)/(e^(-(y + z)*b_q + b_q*u_q) + 1)^2)*Q_0^2*e^(2*z + 2*log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - 2*log(e^(b_q*u_q - b_q*y) + 1)/b_q)/((Q_0 - 1)^2*(Q_0*e^(z + log(e^(-(y + z)*b_q + b_q*u_q) + 1)/b_q - log(e^(b_q*u_q - b_q*y) + 1)/b_q)/(Q_0 - 1) - 1)^2);

    dPhdzdy = dPhdydz;


    % Put Jacobian Matrix together 
    % I'll include even the terms that equal zero so it's easier to read and check
    Jac = zeros(2,2); % order: [dydy dydz; dzdy dzdz]

    Jac(1,1) = dPsdydy + ...
    dPsdydy*Pe*Ph*Pf     + dPsdy*dPedY*Ph*Pf      + dPsdy*Pe*dPhdY*Pf      + dPsdy*Pe*Ph*dPfdY + ...
    dPsdY*dPedy*Ph*Pf    + Ps*dPedydy*Ph*Pf       + Ps*dPedy*dPhdY*Pf      + Ps*dPedy*Ph*dPfdY + ...
    dPsdY*Pe*dPhdy*Pf    + Ps*dPedY*dPhdy*Pf      + Ps*Pe*dPhdydy*Pf       + Ps*Pe*dPhdy*dPfdY + ...
    dPsdY*Pe*Ph*dPfdy    + Ps*dPedY*Ph*dPfdy      + Ps*Pe*dPhdY*dPfdy      + Ps*Pe*Ph*dPfdydy;

    Jac(1,2) = dPsdydz + ...
    dPsdydz*Pe*Ph*Pf     + dPsdy*dPedZ*Ph*Pf      + dPsdy*Pe*dPhdZ*Pf      + dPsdy*Pe*Ph*dPfdZ + ...
    dPsdZ*dPedy*Ph*Pf    + Ps*dPedydz*Ph*Pf       + Ps*dPedy*dPhdZ*Pf      + Ps*dPedy*Ph*dPfdZ + ...
    dPsdZ*Pe*dPhdy*Pf    + Ps*dPedZ*dPhdy*Pf      + Ps*Pe*dPhdydz*Pf       + Ps*Pe*dPhdy*dPfdZ + ...
    dPsdZ*Pe*Ph*dPfdy    + Ps*dPedZ*Ph*dPfdy      + Ps*Pe*dPhdZ*dPfdy      + Ps*Pe*Ph*dPfdydz;

    Jac(2,1) = dPsdzdy + ...
    dPsdzdy*Pe*Ph*Pf     + dPsdz*dPedY*Ph*Pf      + dPsdz*Pe*dPhdY*Pf      + dPsdz*Pe*Ph*dPfdY + ...
    dPsdY*dPedz*Ph*Pf    + Ps*dPedzdy*Ph*Pf       + Ps*dPedz*dPhdY*Pf      + Ps*dPedz*Ph*dPfdY + ...
    dPsdY*Pe*dPhdz*Pf    + Ps*dPedY*dPhdz*Pf      + Ps*Pe*dPhdzdy*Pf       + Ps*Pe*dPhdz*dPfdY + ...
    dPsdY*Pe*Ph*dPfdz    + Ps*dPedY*Ph*dPfdz      + Ps*Pe*dPhdY*dPfdz      + Ps*Pe*Ph*dPfdzdy;

    Jac(2,2) = dPsdzdz + ...
    dPsdzdz*Pe*Ph*Pf     + dPsdz*dPedZ*Ph*Pf      + dPsdz*Pe*dPhdZ*Pf      + dPsdz*Pe*Ph*dPfdZ + ...
    dPsdZ*dPedz*Ph*Pf    + Ps*dPedzdz*Ph*Pf       + Ps*dPedz*dPhdZ*Pf      + Ps*dPedz*Ph*dPfdZ + ...
    dPsdZ*Pe*dPhdz*Pf    + Ps*dPedZ*dPhdz*Pf      + Ps*Pe*dPhdzdz*Pf       + Ps*Pe*dPhdz*dPfdZ + ...
    dPsdZ*Pe*Ph*dPfdz    + Ps*dPedZ*Ph*dPfdz      + Ps*Pe*dPhdZ*dPfdz      + Ps*Pe*Ph*dPfdzdz;

    Jac = M*Jac; % Don't forget migration
    eigJ = eig(Jac);
    eigJ = real(eigJ);
    res = max(eigJ);

    resV = [resV;res];
end

% Plot it within Octave
if length(x_cV) > 1
    plot(x_cV,resV);
    xlabel('Optimal hatching time x_c')
    ylabel('Largest eigenvalue of Jacobian')
    title('Singular strategy is convergence stable where largest eig < 0')
end
